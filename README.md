# Xray DNS Load Balancer

این مخزن مجموعه اسکریپت‌های Bash برای استقرار سامانه پایش Xray و بروزرسانی DNS هتزنر است. نصب روی اوبونتو ۲۲.۰۴ یا ۲۴.۰۴ انجام می‌شود و اجزاء اصلی شامل مانیتورینگ Best-Latency، لودبالانس گردشی، و ربات تلگرام برای مدیریت است.

## اجزاء

- `install.sh` — نصب و پیکربندی کامل سرویس‌ها، وابستگی‌ها، و systemd.
- `xray-dns.sh` — منطق اصلی پایش و به‌روزرسانی رکوردهای DNS.
- `bot.sh` — ربات تلگرام با کیبورد شیشه‌ای برای مدیریت دامنه و کانفیگ‌ها.
- `helpers.sh` — توابع کمکی مشترک (لاگ، HTTP، قفل‌ها و ...).
- `templates/` — تمپلیت اجرای Xray به صورت SOCKS محلی.
- `systemd/` — واحدهای سرویس/تایمر systemd برای مانیتور، روتیشن و ربات.
- `logrotate.conf` — پیکربندی چرخش لاگ‌ها.

## نصب

```bash
sudo bash install.sh
```

اسکریپت نصب ابزارهای مورد نیاز، آخرین نسخه پایدار Xray-Core، ساختار دایرکتوری `/opt/xray-dns` و فایل محیطی `env` را ایجاد می‌کند. در اولین اجرا، توکن‌های هتزنر و تلگرام، آی‌دی مجاز و بازه‌های زمانی از کاربر پرسیده می‌شود. سپس واحدهای systemd فعال می‌گردند:

- `xray-dns.timer` — اجرای پایش Best-Latency (۱۵ یا ۳۰ ثانیه با توجه به env).
- `xray-dns-rotator.timer` — اجرای روتیشن گردشی (پیش‌فرض ۶۰ ثانیه).
- `xray-dns-bot.service` — سرویس دائم ربات تلگرام.

در پایان نصب می‌توان دامنه‌های مورد مدیریت را معرفی کرد تا رکورد A آنها به صورت خودکار ساخته یا بروزرسانی شود.

## استفاده از خط فرمان

```bash
sudo /opt/xray-dns/xray-dns.sh --status
sudo /opt/xray-dns/xray-dns.sh --monitor-once
sudo /opt/xray-dns/xray-dns.sh --rotate-once
sudo /opt/xray-dns/xray-dns.sh --set-domain example.com
```

گزینه `--self-check` وابستگی‌ها، دسترسی API و وجود فایل env را بررسی می‌کند.

## ربات تلگرام

ربات با long-polling کار می‌کند و فقط کاربری که آی‌دی آن در env تعریف شده است دسترسی دارد. امکانات از طریق دکمه‌های Inline ارائه می‌شود:

- مشاهده وضعیت کلی دامنه‌ها و کانفیگ‌ها.
- افزودن/حذف دامنه و کانفیگ‌های Xray.
- تغییر حالت Best-Latency یا Round-Robin.
- تغییر بازه پایش و لودبالانس.
- اجرای تست فوری مانیتورینگ.

## ساختار State و لاگ

- `state/health.json` — وضعیت سلامت کانفیگ‌ها (latency، streak ها و ...).
- `state/domains.json` — دامنه‌ها، zone/record ID و آخرین IP تنظیم‌شده.
- `state/mode` — حالت فعال (`best` یا `rr`).
- `logs/` — شامل `xray-dns.log` و `bot.log` با logrotate روزانه (۷ نسخه فشرده).

## نکات ایمنی

- تمام اسکریپت‌ها با `set -euo pipefail`، قفل فایل و timeout مناسب اجرا می‌شوند.
- env با سطح دسترسی `600` ذخیره شده و در هر اجرا load می‌شود.
- تماس‌های Hetzner و تلگرام با rate-limit ساده و مدیریت خطا انجام می‌شود.
- در صورت عدم وجود کانفیگ سالم، هشدار تلگرام (با cooldown ۵ دقیقه) ارسال و DNS دست‌نخورده می‌ماند.

## تست سلامت

```
sudo /opt/xray-dns/xray-dns.sh --self-check
```

این دستور وجود ابزارهای کلیدی (curl، jq، xray، systemctl) و فایل env را بررسی کرده و نتیجه را در لاگ ثبت می‌کند.
